name: Demo 01 - Getting Started

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'demos/01-getting-started/**'
      - '.github/workflows/demo-01-getting-started.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'demos/01-getting-started/**'
      - '.github/workflows/demo-01-getting-started.yml'
  workflow_dispatch:

jobs:
  setup-prerequisites:
    uses: ./.github/workflows/setup-prerequisites.yml

  demo-test:
    needs: setup-prerequisites
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: demos/01-getting-started
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Kubernetes cluster with Envoy Gateway
      run: |
        echo "ğŸš€ Setting up Kubernetes cluster with Envoy Gateway..."
        # Go back to root directory for initial setup
        cd ../../
        task setup-all
        
    - name: Wait for Envoy Gateway to be ready
      run: |
        echo "â³ Waiting for Envoy Gateway to be ready..."
        cd ../../
        task verify-installation

    - name: Deploy demo components
      run: |
        echo "ğŸš€ Deploying demo components..."
        # Export kubeconfig from kind cluster
        cd ../../
        kind export kubeconfig --name envoy-ai-gateway-demo
        cd demos/01-getting-started
        task deploy
        
    - name: Wait for demo components to be ready
      run: |
        echo "â³ Waiting for demo components to be ready..."
        task wait-ready
        
    - name: Verify deployment status
      run: |
        echo "ğŸ“Š Checking deployment status..."
        kubectl get pods --all-namespaces
        kubectl get gateways --all-namespaces
        kubectl get httproutes --all-namespaces
        task status

    - name: Start port forwarding in background
      run: |
        echo "ğŸ”Œ Starting port forwarding..."
        # Start port forwarding in background
        nohup task port-forward > port-forward.log 2>&1 &
        # Wait a bit for port forwarding to establish
        sleep 10
        # Check if port forwarding is working
        netstat -tlnp | grep :8080 || echo "Port forwarding may not be ready yet"

    - name: Test chat completions endpoint
      run: |
        echo "ğŸ§ª Testing chat completions endpoint..."
        # Wait a bit more to ensure port forwarding is stable
        sleep 5
        task test-chat

    - name: Test models endpoint
      run: |
        echo "ğŸ§ª Testing models endpoint..."
        task test-models

    - name: Test streaming endpoint
      run: |
        echo "ğŸ§ª Testing streaming endpoint..."
        task test-stream

    - name: Run all tests
      run: |
        echo "ğŸ§ª Running all tests..."
        task test

    - name: Show component logs
      if: always()
      run: |
        echo "ğŸ“‹ Showing component logs..."
        task logs || true

    - name: Show port forwarding logs
      if: always()
      run: |
        echo "ğŸ“‹ Port forwarding logs:"
        cat port-forward.log || echo "No port-forward.log found"

    - name: Show failure diagnostics
      if: failure()
      run: |
        echo "ğŸ” Failure diagnostics..."
        echo "=== Pods Status ==="
        kubectl get pods --all-namespaces || true
        echo "=== Gateway Status ==="
        kubectl get gateways --all-namespaces || true
        echo "=== HTTPRoute Status ==="
        kubectl get httproutes --all-namespaces || true
        echo "=== Events ==="
        kubectl get events --all-namespaces --sort-by='.lastTimestamp' || true
        echo "=== Envoy Gateway Logs ==="
        kubectl logs -n envoy-gateway-system -l control-plane=envoy-gateway --tail=50 || true
        echo "=== Demo Component Logs ==="
        kubectl logs -l app=llm-d-inference-sim --tail=50 || true

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleanup..."
        task cleanup || true
        cd ../../
        task cleanup || true
        # Kill any remaining port forwarding processes
        pkill -f "kubectl port-forward" || true
        # Clean up kind cluster
        kind delete clusters --all || true
